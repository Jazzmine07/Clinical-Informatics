<!DOCTYPE html>
<html lang="en">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>IsKlinika</title>

    <!-- Custom fonts for this template-->
    <link href="public/vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">
    <link
        href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
        rel="stylesheet">

    <!-- Custom styles for this template-->
    <link href="public/css/sb-admin-2.min.css" rel="stylesheet">

    <!-- Custom styles for this page -->
    <link href="public/vendor/datatables/dataTables.bootstrap4.min.css" rel="stylesheet"
    >
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />

    <style>
        #reportrange{
            display: inline-block;
            width: 100%;
            height: calc(1.5em + 0.75rem + 2px);
            padding: 0.375rem 1.75rem 0.375rem 0.75rem;
            font-size: 1rem;
            font-weight: 400;
            line-height: 1.5;
            color: #6e707e;
            vertical-align: middle;
            background: #ffff;
            border: 1px solid #d1d3e2;
            border-radius: 0.35rem;
        }

        .dtrg-group.dtrg-start{
            background-color: #f8f9fc !important;
            color: #4e72df;
            font-weight: bold;
        }
    </style>

</head>

<body id="page-top">

    <!-- Page Wrapper -->
    <div id="wrapper">

        <!-- Sidebar -->
        <ul class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion" id="accordionSidebar">

            <!-- Sidebar - Brand -->
            <a class="sidebar-brand d-flex align-items-center justify-content-center" href="/dashboard" style="pointer-events: none; cursor: default;">
                <div class="sidebar-brand-icon rotate-n-15">
                    <i class="fas fa-user-md"></i>
                </div>
                <div class="sidebar-brand-text mx-3 text-capitalize">IsKlinika</div>
            </a>

            <!-- Divider -->
            <hr class="sidebar-divider my-0">


            {{#if isAdmin}}
                <!-- Nav Item - Reports -->
                <li class="nav-item">
                    <a href="#report" data-toggle="collapse" aria-expanded="false" class="dropdown-toggle nav-link">
                        <i class="fas fa-fw fa-table"></i>
                        <span>Reports</span></a>
                    <ul class="collapse show list-unstyled" id="report">
                        <li>
                            <a class="nav-link" href="/reports-clinic-visit">
                                <i class="fas fa-fw fa-medkit"></i>
                                <span>Clinic Visit</span></a>
                        </li>
                        <li>
                            <a class="nav-link" href="/reports-health-assessment">
                                <i class="fas fa-fw fa-stethoscope"></i>
                                <span>Health Assessment</span></a>
                        </li>
                        <li>
                            <a class="nav-link active" href="/reports-inventory">
                                <i class="fas fa-fw fa-archive"></i>
                                <span>Inventory</span></a>
                        </li>
                    </ul>
                </li>

                <!-- Nav Item - Performance Assessment -->
                <li class="nav-item">
                    <a class="nav-link" href="/performance-assessment">
                        <i class="fas fa-fw fa-star"></i>
                        <span>Performance Assessment</span></a>
                </li>

                <!-- Nav Item - Inventory -->
                <li class="nav-item">
                    <a href="#inventory" data-toggle="collapse" aria-expanded="false" class="dropdown-toggle nav-link">
                        <i class="fas fa-fw fa-archive"></i>
                        <span>Inventory</span></a>
                    <ul class="collapse show list-unstyled" id="inventory">
                        <li>
                            <a class="nav-link" href="/inventory-medicine">
                                <i class="fas fa-fw fa-tablets"></i>
                                <span>Medicine</span></a>
                        </li>
                        <li>
                            <a class="nav-link" href="/inventory-supply">
                                <i class="fas fa-fw fa-pump-medical"></i>
                                <span>Supply</span></a>
                        </li>
                        <li>
                            <a class="nav-link" href="/inventory-dental">
                                <i class="fas fa-fw fa-tooth"></i>
                                <span>Dental</span></a>
                        </li>
                    </ul>
                </li>

            {{else}}

                <!-- Nav Item - Dashboard -->
                <li class="nav-item">
                    <a class="nav-link" href="/dashboard">
                        <i class="fas fa-fw fa-tachometer-alt"></i>
                        <span>Dashboard</span></a>
                </li>
                
                <!-- Nav Item - Disease Surveillance -->
                <li class="nav-item">
                    <a class="nav-link" href="/disease-surveillance">
                        <i class="fas fa-fw fa-virus"></i>
                        <span>Disease Surveillance</span></a>
                </li>

                <!-- Nav Item - Clinic Visit -->
                <li class="nav-item">
                    <a class="nav-link" href="/clinic-visit">
                        <i class="fas fa-fw fa-medkit"></i>
                        <span>Clinic Visit</span></a>
                </li>

                <!-- Nav Item - Profile -->
                <li class="nav-item">
                    <a class="nav-link" href="/profile">
                        <i class="fas fa-fw fa-user"></i>
                        <span>Student Profile</span></a>
                </li>

                <!-- Nav Item - Health Assessment -->
                <li class="nav-item">
                    <a class="nav-link" href="/health-assessment">
                        <i class="fas fa-fw fa-stethoscope"></i>
                        <span>Health Assessment</span></a>
                </li>

                <!-- Nav Item - Inventory -->
                <li class="nav-item">
                    <a href="#inventory" data-toggle="collapse" aria-expanded="false" class="dropdown-toggle nav-link">
                        <i class="fas fa-fw fa-archive"></i>
                        <span>Inventory</span></a>
                    <ul class="collapse list-unstyled" id="inventory">
                        <li>
                            <a class="nav-link" href="/inventory-medicine">
                                <i class="fas fa-fw fa-tablets"></i>
                                <span>Medicine</span></a>
                        </li>
                        <li>
                            <a class="nav-link" href="/inventory-supply">
                                <i class="fas fa-fw fa-pump-medical"></i>
                                <span>Supply</span></a>
                        </li>
                        <li>
                            <a class="nav-link" href="/inventory-dental">
                                <i class="fas fa-fw fa-tooth"></i>
                                <span>Dental</span></a>
                        </li>
                    </ul>
                </li>

                <!-- Nav Item - Promotive Care -->
                <li class="nav-item">
                    <a class="nav-link" href="/promotive-care">
                        <i class="fas fa-fw fa-child"></i>
                        <span>Promotive Care</span></a>
                </li>

                <!-- Nav Item - Performance Assessment -->
                <li class="nav-item">
                    <a class="nav-link" href="/performance-assessment">
                        <i class="fas fa-fw fa-star"></i>
                        <span>Performance Assessment</span></a>
                </li>

                <!-- Nav Item - Communications -->
                <li class="nav-item">
                    <a class="nav-link" href="/communications">
                        <i class="fas fa-fw fa-comments"></i>
                        <span>Communications</span></a>
                </li>

                <!-- Nav Item - Reports -->
                <li class="nav-item">
                    <a href="#report" data-toggle="collapse" aria-expanded="false" class="dropdown-toggle nav-link">
                        <i class="fas fa-fw fa-table"></i>
                        <span>Reports</span></a>
                    <ul class="collapse show list-unstyled" id="report">
                        <li>
                            <a class="nav-link" href="/reports-clinic-visit">
                                <i class="fas fa-fw fa-medkit"></i>
                                <span>Clinic Visit</span></a>
                        </li>
                        <li>
                            <a class="nav-link" href="/reports-health-assessment">
                                <i class="fas fa-fw fa-stethoscope"></i>
                                <span>Health Assessment</span></a>
                        </li>
                        <li>
                            <a class="nav-link active" href="/reports-inventory">
                                <i class="fas fa-fw fa-archive"></i>
                                <span>Inventory</span></a>
                        </li>
                    </ul>
                </li>
            {{/if}}

            <!-- Divider -->
            <hr class="sidebar-divider d-none d-md-block">

            <!-- Sidebar Toggler (Sidebar) -->
            <div class="text-center d-none d-md-inline">
                <button class="rounded-circle border-0" id="sidebarToggle"></button>
            </div>

        </ul>
        <!-- End of Sidebar -->

        <!-- Content Wrapper -->
        <div id="content-wrapper" class="d-flex flex-column">

            <!-- Main Content -->
            <div id="content">

                <!-- Topbar -->
                <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow">

                    <!-- Sidebar Toggle (Topbar) -->
                    <button id="sidebarToggleTop" class="btn btn-link d-md-none rounded-circle mr-3">
                        <i class="fa fa-bars"></i>
                    </button>

                    <!-- Topbar Navbar -->
                    <ul class="navbar-nav ml-auto">

                        <!-- Nav Item - Search Dropdown (Visible Only XS) -->
                        <li class="nav-item dropdown no-arrow d-sm-none">
                            <a class="nav-link dropdown-toggle" href="#" id="searchDropdown" role="button"
                                data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <i class="fas fa-search fa-fw"></i>
                            </a>
                            <!-- Dropdown - Messages -->
                            <div class="dropdown-menu dropdown-menu-right p-3 shadow animated--grow-in"
                                aria-labelledby="searchDropdown">
                                <form class="form-inline mr-auto w-100 navbar-search">
                                    <div class="input-group">
                                        <input type="text" class="form-control bg-light border-0 small"
                                            placeholder="Search for..." aria-label="Search"
                                            aria-describedby="basic-addon2">
                                        <div class="input-group-append">
                                            <button class="btn btn-primary" type="button">
                                                <i class="fas fa-search fa-sm"></i>
                                            </button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </li>

                        {{>notifications}}

                        <div class="topbar-divider d-none d-sm-block"></div>

                        <!-- Nav Item - User Information -->
                        <li class="nav-item dropdown no-arrow">
                            <a class="nav-link dropdown-toggle" href="#drop-menu" id="userDropdown" role="button"
                                data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <span class="mr-2 d-none d-lg-inline text-gray-600 small">Welcome, {{user.firstName}} {{user.lastName}}!</span>
                                <img class="img-profile rounded-circle"
                                    src="public/img/undraw_profile.svg">
                            </a>
                            <!-- Dropdown - User Information -->
                            <div id="drop-menu" class="dropdown-menu dropdown-menu-right shadow animated--grow-in"
                                aria-labelledby="userDropdown">
                                <a class="dropdown-item" href="#">
                                    <i class="fas fa-cogs fa-sm fa-fw mr-2 text-gray-400"></i>
                                    Settings
                                </a>
                                <a class="dropdown-item" href="#">
                                    <i class="fas fa-list fa-sm fa-fw mr-2 text-gray-400"></i>
                                    Activity Log
                                </a>
                                <div class="dropdown-divider"></div>
                                <a class="dropdown-item" data-toggle="modal" data-target="#logoutModal">
                                    <i class="fas fa-sign-out-alt fa-sm fa-fw mr-2 text-gray-400"></i>
                                    Logout
                                </a>
                            </div>
                        </li>

                    </ul>

                </nav>
                <!-- End of Topbar -->                   

                <!-- Begin Page Content -->
                <div class="container-fluid">
                    <!-- Page Heading -->
                    <div class="d-sm-flex align-items-center justify-content-between mb-4">
                        <h1 class="h3 mb-0 text-gray-800">Inventory Report</h1>
                        <div class="d-flex flex-row-reverse">
                            <button type="button" id="downloadBtn" class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm"><i class="fas fa-download fa-sm text-white-50 mr-1"></i>Download</button>
                            {{!-- <a data-toggle="modal" style="color: white;" data-target="#modalFI" class="d-none d-sm-inline-block btn btn-sm mr-2 btn-primary shadow-sm"><i
                                class="fas fa-dolly-flatbed mr-1 text-white-50"></i> Forecast Medicine Inventory</a> --}}
                        </div>
                    </div>

                    {{!-- <div class="modal fade" id="modalFI" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
                        <div class="modal-dialog" style="max-width: 1200px; margin-top: 100px;" role="document">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="exampleModalLongTitle">Forecast Medicine Inventory</h5>
                                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                                <div class="modal-body">
                                    <table class="table table-bordered">
                                        <thead>
                                            <tr style="text-align: center;">
                                                <th class="bg-primary" style="color: white;">Item Name</th>
                                                <th class="bg-primary" style="color: white;">Estimated Quantity Needed</th>
                                                <th class="bg-primary" style="color: white;">Conservative Estimate</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr>
                                                <td>Paracetamol Suspension 250mg/5mL</td>
                                                <td style="text-align: center;">50</td>
                                                <td style="text-align: center;">40</td>
                                            </tr>
                                            <tr>
                                                <td>Antacid (Kremil-S) Chewable Tablet 178mg/233mg/30mg</td>
                                                <td style="text-align: center;">39</td>
                                                <td style="text-align: center;">27</td>
                                            </tr>
                                            <tr>
                                                <td>Neozep Non-Drowsy Tablet 10mg/500mg</td>
                                                <td style="text-align: center;">44</td>
                                                <td style="text-align: center;">23</td>
                                            </tr>
                                        </tbody>
                                    </table>                                     
                                    <div class="modal-footer">
                                        <a href="#" class="btn btn-danger" data-dismiss="modal">Cancel</a>
                                        <button type="submit" id="searchDEBtn" class="btn btn-success">Download</a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div> --}}
                    
                    <div class="row">
                        <div class="col-4 mb-4">
                            <div id="reportrange">
                                <i class="fa fa-calendar"></i>&nbsp;
                                <span></span> <i class="fa fa-caret-down"></i>
                            </div>
                        </div> 
                    </div>
                    <!-- DataTales Example -->
                    {{!-- <div class="card shadow mb-4">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">Medicine Inventory Discrepancy Report</h6>
                        </div>
                        <div class="card-body">
                            <div class="invalid-feedback align-items-center" style="font-size: 12px; display: none;" id="errorDiv"></div>
                            <div class="table-responsive">
                                <table class="table table-bordered" id="usedMedicineTable" width="100%" cellspacing="0">
                                    <thead>
                                        <tr>
                                            <th class="bg-primary" style="color: white;">Batch Number</th>
                                            <th class="bg-primary" style="color: white;">Medicine</th>
                                            <th class="bg-primary" style="color: white;">Current Inventory</th>
                                            <th class="bg-primary" style="color: white;">Unit</th>
                                            <th class="bg-primary" style="color: white;">Date Recorded</th>
                                            <th class="bg-primary" style="color: white;">Discrepancy</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {{!-- {{#each usedMedicine}}
                                            <tr id="{{medicineID}}">
                                                <td>{{batchNum}}</td>
                                                <td>{{medicineName}}</td>
                                                <td>{{currInventory}}</td>
                                                <td>{{unit}}</td>
                                                <td>{{usedInventory}}</td>
                                            </tr>
                                        {{/each}}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div> --}}

                    <!-- Top medicines used chart -->
                    <div class="card shadow mb-4">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary">Top 5 Medicines Used</h6>
                        </div>
                        <div class="card-body">
                            <div style="height: 600px">
                                <canvas id="top5medsByGrade"></canvas>
                            </div>
                            {{!-- <div class="chart-area">
                                <canvas id="top5medsBySex"></canvas>
                            </div> --}}
                        </div>
                    </div>
                    <div class="card shadow mb-4" id="medDiv" style="display: none;">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary" id="medTitle"></h6>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered" id="medTable" width="100%" cellspacing="0">
                                    <thead>
                                        <tr style="text-align: center;">
                                            <th class="bg-primary" style="color: white;">Batch Number</th>
                                            <th class="bg-primary" style="color: white;">Medicine Name</th>
                                            <th class="bg-primary" style="color: white;">Current Inventory</th>
                                            <th class="bg-primary" style="color: white;">Unit</th>
                                            <th class="bg-primary" style="color: white;">Date Recorded</th>
                                            <th class="bg-primary" style="color: white;">Discrepancy</th>
                                        </tr>
                                    </thead>
                                    <tbody id="medBody">                                                
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div> 
                    <div class="card shadow mb-4" id="supDiv" style="display: none;">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary" id="supTitle"></h6>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered" id="supTable" width="100%" cellspacing="0">
                                    <thead>
                                        <tr style="text-align: center;">
                                            <th class="bg-primary" style="color: white;">Batch Number</th>
                                            <th class="bg-primary" style="color: white;">Supply Name</th>
                                            <th class="bg-primary" style="color: white;">Current Inventory</th>
                                            <th class="bg-primary" style="color: white;">Unit</th>
                                            <th class="bg-primary" style="color: white;">Date Recorded</th>
                                            <th class="bg-primary" style="color: white;">Discrepancy</th>
                                        </tr>
                                    </thead>
                                    <tbody id="supBody">                                                
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div> 
                    <div class="card shadow mb-4" id="denDiv" style="display: none;">
                        <div class="card-header py-3">
                            <h6 class="m-0 font-weight-bold text-primary" id="denTitle"></h6>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-bordered" id="denTable" width="100%" cellspacing="0">
                                    <thead>
                                        <tr style="text-align: center;">
                                            <th class="bg-primary" style="color: white;">Batch Number</th>
                                            <th class="bg-primary" style="color: white;">Dental Supply Name</th>
                                            <th class="bg-primary" style="color: white;">Current Inventory</th>
                                            <th class="bg-primary" style="color: white;">Unit</th>
                                            <th class="bg-primary" style="color: white;">Date Recorded</th>
                                            <th class="bg-primary" style="color: white;">Discrepancy</th>
                                        </tr>
                                    </thead>
                                    <tbody id="denBody">                                                
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>      
                </div>
                <!-- /.container-fluid -->
            </div>
            <!-- End of Main Content -->

            <!-- Footer -->
            <footer class="sticky-footer bg-white">
                <div class="container my-auto">
                    <div class="copyright text-center my-auto">
                        <span>Copyright &copy; IsKlinika 2021</span>
                    </div>
                </div>
            </footer>
            <!-- End of Footer -->

        </div>
        <!-- End of Content Wrapper -->

    </div>
    <!-- End of Page Wrapper -->

    <!-- Scroll to Top Button-->
    <a class="scroll-to-top rounded" href="#page-top">
        <i class="fas fa-angle-up"></i>
    </a>

    <!-- Logout Modal-->
    <div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel">Ready to Leave?</h5>
                    <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">×</span>
                    </button>
                </div>
                <div class="modal-body">Select "Logout" below if you are ready to end your current session.</div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" type="button" data-dismiss="modal">Cancel</button>
                    <form method="post" action="/logout">
                        <button class="btn btn-primary">Logout</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap core JavaScript-->
    <script src="public/vendor/jquery/jquery.min.js"></script>
    <script src="public/vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

    <!-- Core plugin JavaScript-->
    <script src="public/vendor/jquery-easing/jquery.easing.min.js"></script>

    <!-- Custom scripts for all pages-->
    <script src="public/js/sb-admin-2.min.js"></script>

    <!-- Page level plugins -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    {{!-- <script src="public/vendor/chart.js/Chart.min.js"></script> --}}

    <!-- Page level custom scripts -->
    {{!-- <script src="public/js/demo/chart-pie-demo.js"></script> --}}

    <!-- Page level plugins -->
    <script src="public/vendor/datatables/jquery.dataTables.min.js"></script>
    <script src="public/vendor/datatables/dataTables.bootstrap4.min.js"></script>

    <!-- Page level custom scripts -->
    <script src="public/js/demo/datatables-demo.js"></script>

    <script src="https://cdn.datatables.net/rowgroup/1.1.4/js/dataTables.rowGroup.min.js"></script>

    <script type="text/javascript" src="https://cdn.jsdelivr.net/jquery/latest/jquery.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/1.5.3/jspdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.6/jspdf.plugin.autotable.min.js"></script>

    <script>
    //$(document).ready(function(){
        const now = new Date();
        var year = now.getFullYear();
        var lastYear = now.getFullYear() - 1;
        var month = now.getMonth() + 1;
        //var date = now.getDate();
        var date = 29;

        console.log("year: " + year);
        console.log("month: " + month);
        console.log("date: " + date);

        var invetoryMedicine = [];

        //var start = moment().subtract(29, 'days');
        //var end = moment();

        if(month <= 3){
            console.log("month: " + month);
            getMonthDateRange(year-1);  
        }
        else if(month > 3){
            console.log("month: " + month);
            getMonthDateRange(year);  
        }

        function getMonthDateRange(year) {
            console.log("pumapasok ba dito");

            start = moment([year, 5]);
            end = moment([year + 1, 2]).endOf('month');

            console.log(start.toDate());
            console.log(end.toDate());

            cb(start, end);
        }

        var startDate, endDate;
        var checker = false;

        //var medTable = $('#medTable').DataTable();
        //var supTable = $('#medTable').DataTable();
        //var denTable = document.getElementById("denTable");

        function cb(start, end) {
            $('#reportrange span').html(start.format('MMMM D, YYYY') + ' - ' + end.format('MMMM D, YYYY'));
            console.log("START " + start.format('YYYY-MM-DD'));
            console.log("END " + end.format('YYYY-MM-DD'));

            startDate = new Date(start);
            endDate = new Date(end);

            $.get("/getTop5MedsUsedMonth",{start: start.format('YYYY-MM-DD'), end:end.format('YYYY-MM-DD')},function(data){
                if(checker){
                    stackedBarChart.destroy();
                }

                var intakeData=data[0];
                var top5=data[1];
                var labels=[];

                var dataCountG1=[0,0,0,0,0],dataCountG2=[0,0,0,0,0],dataCountG3=[0,0,0,0,0],dataCountG4=[0,0,0,0,0],dataCountG5=[0,0,0,0,0],dataCountG6=[0,0,0,0,0];
                var i, j;
                var top5medsTemp;

                console.log("TOP 5");
                console.log(top5);

                //used to sort from highest to lowest
                if(top5.length>0){
                    top5medsTemp = top5.sort(function (x, y) {
                        return y.count- x.count;
                    });
                }


                //used to ensure to only get top5
                if(top5.length>=5){
                    for(j=0;j<5;j++){
                        labels.push(top5medsTemp[j].medicineName);
                    }
                }
                else if(top5.length<5){
                    for(j=0;j<top5.length;j++){
                        labels.push(top5medsTemp[j].medicineName);
                    }
                }
                

                for(i=0;i<intakeData.length;i++){
                    for(j=0;j<top5.length;j++){
                        if(intakeData[i].medicineName == top5[j].medicineName){
                            if(intakeData[i].grade=="1"){
                                 dataCountG1[j]=dataCountG1[j]+1;
                            }  
                            else if(intakeData[i].grade=="2"){
                                dataCountG2[j]=dataCountG2[j]+1;
                            }   
                            else if(intakeData[i].grade=="3"){
                                dataCountG3[j]=dataCountG3[j]+1;
                            }                                
                            else if(intakeData[i].grade=="4"){
                                dataCountG4[j]=dataCountG4[j]+1;
                            }   
                            else if(intakeData[i].grade=="5"){
                                dataCountG5[j]=dataCountG5[j]+1;
                            }
                            else if(intakeData[i].grade=="6"){
                                dataCountG6[j]=dataCountG6[j]+1;
                            }
                                
                        }
                    }
                }
                
                //console.log("labels "+labels);
                //console.log("endRange "+endRange);
                top5UsedMedsGrade(dataCountG1,dataCountG2,dataCountG3,dataCountG4,dataCountG5,dataCountG6,labels, intakeData);
                checker = true;
            });

            $.get('/getMedicineDiscrepancyReport', {start: startDate, end: endDate}, function(result){
                console.log("medicine discrepancy result");
                console.log(result);

                if(result.length != 0){
                    $("#medBody tr").remove();
                    document.getElementById("medDiv").style.display = "block";
                    $('#medTitle').text("");
                    $('#medTitle').text("Medicine Discrepancy from " + start.format('MMMM D, YYYY') + ' to ' + end.format('MMMM D, YYYY'));

                    for(var i = 0; i < result.length; i++){
                        let date = new Date(result[i].dateUpdated)
                        let month = date.toLocaleString('default', { month: 'long' })
                        let dateUpdated = month + ' ' + date.getDate() + ', ' + date.getFullYear();
                        //medTable.row.add([result[i].batchNum, result[i].medicineName, result[i].currInventory, result[i].unit, result[i].dateUpdated, result[i].usedInventory]);
                        $('#medBody').append('<tr><td style="text-align: center;">' + result[i].batchNum + '</td><td>' + result[i].medicineName + '</td><td style="text-align: right;">' + result[i].currInventory + '</td><td>' + result[i].unit + '</td><td style="text-align: right;">' + dateUpdated + '</td><td style="text-align: right;">' + result[i].usedInventory + '</td></tr>');
                    }       
                    //medTable.draw();
                } 
                else{
                    $("#medBody tr").remove();
                    $('#medBody').append('<tr><td colspan="6" class="font-weight-normal text-center">' + "No data available" + '</td></tr>');   
                } 
            });

            $.get('/getSupplyDiscrepancyReport', {start: startDate, end: endDate}, function(result){
                console.log("supply discrepancy result");
                console.log(result);

                if(result.length != 0){
                    $("#supBody tr").remove();
                    document.getElementById("supDiv").style.display = "block";
                    $('#supTitle').text("Supply Discrepancy from " + start.format('MMMM D, YYYY') + ' to ' + end.format('MMMM D, YYYY'));

                    for(var i = 0; i < result.length; i++){
                        let date = new Date(result[i].dateUpdated)
                        let month = date.toLocaleString('default', { month: 'long' })
                        let dateUpdated = month + ' ' + date.getDate() + ', ' + date.getFullYear();
                        //supTable.row.add([result[i].batchNum, result[i].supplyName, result[i].currInventory, result[i].unit, result[i].dateUpdated, result[i].discrepancy]);
                        $('#supBody').append('<tr><td>' + result[i].batchNum + '</td><td>' + result[i].supplyName + '</td><td>' + result[i].currInventory + '</td><td>' + result[i].unit + '</td><td>' + dateUpdated + '</td><td>' + result[i].discrepancy + '</td></tr>');
                    }       
                    //supTable.draw();
                }
                else{
                    $("#supBody tr").remove();
                    $('#supBody').append('<tr><td colspan="6" class="font-weight-normal text-center">' + "No data available" + '</td></tr>');   
                }
            });

            $.get('/getDentalDiscrepancyReport', {start: startDate, end: endDate}, function(result){
                console.log("dental discrepancy result");
                console.log(result);

                if(result.length != 0){
                    $("#denBody tr").remove();
                    document.getElementById("denDiv").style.display = "block"; 
                    $('#denTitle').text("Dental Discrepancy from " + start.format('MMMM D, YYYY') + ' to ' + end.format('MMMM D, YYYY'));  

                    for(var i = 0; i < result.length; i++){
                        let date = new Date(result[i].dateUpdated)
                        let month = date.toLocaleString('default', { month: 'long' })
                        let dateUpdated = month + ' ' + date.getDate() + ', ' + date.getFullYear();
                        //denTable.row.add([result[i].batchNum, result[i].dentalName, result[i].currInventory, result[i].unit, result[i].dateUpdated, result[i].discrepancy]);
                        $('#denBody').append('<tr><td>' + result[i].batchNum + '</td><td>' + result[i].dentalName + '</td><td>' + result[i].currInventory + '</td><td>' + result[i].unit + '</td><td>' + dateUpdated + '</td><td>' + result[i].discrepancy + '</td></tr>');
                    }       
                    //denTable.draw();
                }
                else{
                    $("#denBody tr").remove();
                    $('#denBody').append('<tr><td colspan="6" class="font-weight-normal text-center">' + "No data available" + '</td></tr>');   
                }
            });
        }

        var stackedBarChart;
        function top5UsedMedsGrade(dataCountG1,dataCountG2,dataCountG3,dataCountG4,dataCountG5,dataCountG6,labels, intakeData) {
            var sections =[], sectionsCount=[];
            var curr =  new Date();
            var currYear = curr.getFullYear();
            var currentMonth = curr.toLocaleString('default', { month: 'long' });

            //var startDate = new Date(start);
            var getStartMonth = startDate.toLocaleString('default', { month: 'long' })
            var startRange = getStartMonth + ' ' + startDate.getDate() + ', ' + startDate.getFullYear();

            var getEndMonth = endDate.toLocaleString('default', { month: 'long' })
            var endRange = getEndMonth + ' ' + endDate.getDate() + ', ' + endDate.getFullYear();

            console.log("startRange");
            console.log(startRange)
            console.log("endRange");
            console.log(endRange)
            var gradeData={
                labels: labels, // x-axis
                datasets: [{
                    label: "Grade 1",                           
                    backgroundColor: "rgba(153, 102, 255, 0.5)", // violet  
                    data: dataCountG1,   // values of the point
                }, {
                    label: "Grade 2",
                    backgroundColor: "rgb(255, 159, 64)",  // orange
                    data: dataCountG2,
                }, {
                    label: "Grade 3",
                    backgroundColor: "rgb(255, 205, 86)",  // yellow
                    data: dataCountG3,
                }, {
                    label: "Grade 4",
                    backgroundColor: "#32CD32", // green
                    data: dataCountG4,
                }, {
                    label: "Grade 5",
                    backgroundColor: "rgb(54, 162, 235)", // blue
                    data: dataCountG5,
                }, {
                    label: "Grade 6",
                    backgroundColor: "rgb(255, 99, 132)", // red
                    data: dataCountG6,
                }],
            }           

            var config={
                type: 'bar',
                data: gradeData,
                plugins: [ChartDataLabels],
                options: {
                    maintainAspectRatio: false,
                    plugins: {
                        datalabels: {
                            anchor: 'middle',
                            align: 'middle',
                            font: {
                                weight: 'bold',
                                size: 15
                            },
                            color: "#000000",
                            formatter: (value) => {
                                return value > 0 ? value : '';
                            }
                        },
                        title: {
                            display: true,
                            text: 'Top 5 Medicines Used from ' + startRange + ' to ' + endRange,
                            font: {
                                size: 25   // font size of the labels
                            },
                        },
                        legend: {
                            display: true,
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Top 5 Medicines Used',
                                font: {
                                    size: 15,   // font size of the labels
                                    weight: 'bold'
                                },
                            },
                            ticks: {
                                font: {
                                    size: 15   // font size of the labels
                                },
                                
                            },
                            stacked: true,
                        },
                        y: {
                            title: {
                                font: {
                                    size: 15,   // font size of the labels
                                    weight: 'bold'
                                },
                                //color: "rgba(255, 99, 132, 1)",
                            },
                            ticks: {
                                font: {
                                    size: 15,   // font size of the labels
                                },
                                //color: "rgba(255, 99, 132, 1)",
                            },
                            stacked: true,
                        },
                    },
                }
            }

            var top5MedsGrade = document.getElementById("top5medsByGrade");
            stackedBarChart = new Chart(top5MedsGrade, config);

            function clickHandler(click){
                const barColorBackground = [];
                var labelColor;
                var medicineNameChosen = [];
                const points= stackedBarChart.getElementsAtEventForMode(click,'nearest',{ intersect:true},true);
                if(points.length){
                    if(stackedBarChart.config.data == gradeData){
                        var firstPoint = points[0];
                        console.log(points[0]);
                        console.log(firstPoint.datasetIndex);
                        console.log(firstPoint.index);
                        var chosen= labels[firstPoint.index];
                        medicineNameChosen.push(chosen);
                        if(sections!=null){
                            for(i=0;i<6;i++){
                                sections.pop();
                                barColorBackground.pop();
                            }
                        }
                        sectionsCount=[0,0,0,0,0,0]
                        if(sections==null || sections.length==0){
                            console.log("HI");
                            console.log(labels[firstPoint.index]);
                            if(firstPoint.datasetIndex == 0){
                                grade = "Grade 1";
                                sections.push("Truthfulness");
                                sections.push("Sincerity");
                                sections.push("Honesty");
                                sections.push("Faithfulness");
                                sections.push("Humility");
                                sections.push("Politeness");
                                barColorBackground.push('#c67aff', '#bf6bff', '#b85cff', '#af47ff','#a938ff', '#a229ff');
                                labelColor = '#FFFFFF';
                            }
                            else if(firstPoint.datasetIndex == 1){
                                grade = "Grade 2";
                                sections.push("Simplicity");
                                sections.push("Charity");
                                sections.push("Helpfulness");
                                sections.push("Gratefulness");
                                sections.push("Gratitude");
                                sections.push("Meekness");
                                barColorBackground.push('#ffc65c', '#ffbf47', '#ffb938', '#ffb429', '#ffad14', '#ffa805');
                                labelColor = '#000000';
                            }
                            else if(firstPoint.datasetIndex == 2){
                                grade = "Grade 3";
                                sections.push("Respect");
                                sections.push("Courtesy");
                                sections.push("Trust");
                                sections.push("Kindness");
                                sections.push("Piety");
                                sections.push("Prayerfulness");
                                barColorBackground.push('#ffeb7a', '#ffe96b', '#ffe75c', '#ffe347', '#ffe138', '#ffdf29');
                                labelColor = '#000000';
                            }
                            else if(firstPoint.datasetIndex == 3){
                                grade = "Grade 4";
                                sections.push("Unity");
                                sections.push("Purity");
                                sections.push("Fidelity");
                                sections.push("Equality");
                                sections.push("Harmony");
                                sections.push("Solidarity");
                                barColorBackground.push('#7aff7a', '#52ff52', '#00e600', '#00cc00', '#00b300', '#009400');
                                labelColor = '#000000';
                            }
                            else if(firstPoint.datasetIndex == 4){
                                grade = "Grade 5";
                                sections.push("Trustworthiness");
                                sections.push("Reliability");
                                sections.push("Dependability");
                                sections.push("Responsibility");
                                sections.push("Serenity");
                                sections.push("Flexibility");
                                barColorBackground.push('#2929ff', '#0505ff', '#0000e6', '#0000cc', '#0000b3', '#000094');
                                labelColor = '#FFFFFF';
                            }
                            else if(firstPoint.datasetIndex == 5){
                                grade = "Grade 6";
                                sections.push("Self-Discipline");
                                sections.push("Abnegation");
                                sections.push("Self-Giving");
                                sections.push("Integrity");
                                sections.push("Perseverance");
                                sections.push("Patience");
                                barColorBackground.push('#ff7a7a', '#ff4242', '#ff0505', '#e60000', '#cc0000', '#b30000', '#940000');
                                labelColor = '#FFFFFF';
                            }
                            
                            console.log("IntakeData Data:")
                            console.log(intakeData[intakeData.length-1]);
                            console.log("END");

                            for(i=0;i<intakeData.length;i++){
                                if(medicineNameChosen[0].toLowerCase() == intakeData[i].medicineName.toLowerCase()){
                                    for(j=0;j<sections.length;j++){
                                        if(sections[j]== intakeData[i].section){
                                            sectionsCount[j]=sectionsCount[j]+1;
                                        }
                                    }
                                }
                            }

                            var sectionData = {
                                labels: sections, // x-axis
                                datasets: [{        // border color of the line and legend border
                                    backgroundColor: barColorBackground,
                                    data: sectionsCount,   // values of the point
                                }],
                            }
                            console.log(sectionsCount);
                            stackedBarChart.config.data = sectionData;
                            stackedBarChart.config.options.plugins.datalabels.color = labelColor;
                            stackedBarChart.config.options.plugins.title.text = 'Used ' + medicineNameChosen[0] + ' from ' + startRange + ' to ' + endRange +' by ' + grade + ' Sections';
                            stackedBarChart.config.options.plugins.legend.display = false;
                            stackedBarChart.config.options.scales.y.ticks.stepSize = 5;
                        }
                        stackedBarChart.update();
                    }
                }
            }
            top5MedsGrade.onclick=clickHandler;
        }
    //});

    $('#reportrange').daterangepicker({
        startDate: start,
        endDate: end,
        ranges: {
        'Today': [moment(), moment()],
        'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
        'Last 7 Days': [moment().subtract(6, 'days'), moment()],
        'Last 30 Days': [moment().subtract(29, 'days'), moment()],
        'This Month': [moment().startOf('month'), moment().endOf('month')],
        'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
        }
    }, cb);

    //cb(start, end);

    function generate() {
        const now = new Date();
        var thisYear = now.getFullYear();
        var month = now.getMonth() + 1;
        var thisMonth = now.getMonth() + 1;
        if (thisMonth < 10) {
            thisMonth = '0' + thisMonth;
        }

        var thisDay = now.getDate();
        if (thisDay < 10) {
            thisDay = '0' + thisDay;
        }

        var schoolYear;

        if(month >= 6){
            schoolYear = thisYear + "-" + (thisYear + 1);

        }
        else{
            schoolYear = (thisYear - 1) + "-" + (thisYear);
        }

        var title = document.getElementById("medTitle").innerHTML;
        var fullTitle = title + ' (S.Y. ' + schoolYear + ')' + '\n' + 'Date Generated: ' + thisYear + '/' + thisMonth + '/' + thisDay;
        var doc = new jsPDF('p', 'pt', 'letter');
        var htmlstring = '';
        var tempVarToCheckPageHeight = 0;
        var pageHeight = 0;
        pageHeight = doc.internal.pageSize.height;
        specialElementHandlers = {
            // element with id of "bypass" - jQuery style selector  
            '#bypassme': function (element, renderer) {
                // true = "handled elsewhere, bypass text extraction"  
                return true
            }
        };
        margins = {
            top: 150,
            bottom: 60,
            left: 20,
            right: 20,
            width: 600
        };
        var y = 20;
        doc.setLineWidth(2);
        doc.text(30, y = y + 30, fullTitle);
        doc.autoTable({
            html: '#medTable',
            startY: 70,
            columnStyles: {
                0: {halign: "center"},
                2: {halign: "right"},
                4: {halign: "right"},
                5: {halign: "right"}
            }
        })
        doc.save(title +'.pdf');
    }

    $('#downloadBtn').click(function () {
        var stackedBarChartImg = stackedBarChart.toBase64Image();

        var a = document.createElement('a');
        a.href = stackedBarChartImg;

        a.download = 'top-5-medicines-used-by-grade-level.png';

        // Trigger the download
        a.click();
        generate();
    });
    </script>

</body>

</html>